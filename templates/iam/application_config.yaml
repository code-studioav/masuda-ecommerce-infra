AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  EnvironmentName:
    Type: String
  AppName:
    Type: String
  EcommerBucketAccess:
    Type: String
Resources:
  EcommerceIamUser:
    Type: AWS::IAM::User
    Properties:
      Tags: 
        - Key: projectName
          Value: !Ref AppName
        - Key: environment
          Value: !Ref EnvironmentName
      UserName: !Sub '${EnvironmentName}-${AppName}-platform-application-user'
  EcommerceIamAccessKeys:
    Type: AWS::IAM::AccessKey
    Properties:
      Status: 'Active'
      UserName: !Ref EcommerceIamUser
  EcommerceIamUserCredentialsSecret:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Name: !Sub "${EnvironmentName}-${AppName}-app-user-credentials"
      Description: This secret store the credentials of the IAM user for this app.
      SecretString: !Sub
        - '{"AccessKeyId":"${UserName}", "SecretAccessKey":"${Password}"}'
        - UserName: !Ref EcommerceIamAccessKeys
          Password: !GetAtt EcommerceIamAccessKeys.SecretAccessKey
  EcommerceIamRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-${AppName}-principal-platform-role'
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !GetAtt EcommerceIamUser.Arn
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${EnvironmentName}-${AppName}-${Country}-bucket-access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Ref EcommerBucketAccess
              - Effect: Allow
                Action:
                  - s3:*Object
                Resource:
                  - !Sub '${EcommerBucketAccess}/*'
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref EcommerceIamUserCredentialsSecret

Outputs:
  EcommerceIamUserName:
    Value: !Ref EcommerceIamUser
    Description: Name of the IAM user
  EcommerceIamUserCredentialsSecretArn:
    Value: !Ref EcommerceIamUserCredentialsSecret
    Description: Arn whre stored access credentials